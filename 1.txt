#!/bin/bash -e

# jenkins使用脚本,用于构建镜像

# 版本号
version=$2
# 分支
env=$3
# 内网IP
inner_ip=$1
echo "内网IP :${inner_ip}"
if [ -z "${inner_ip}" ]; then
  echo "====================== warning:请传入内网ip ======================"
  return
fi

if [ -z "${version}" ]; then
  version="latest"
  echo "====================== no version:this version is ${version} ======================"
fi
echo "版本号 :${version}"

if [ -z "${env}" ]; then
  env=".dev"
  echo "====================== now env is ${env} ======================"
fi
echo "环境 :${env}"

# 公网hub仓库
hub=

build_access_rpc() {
  echo "============================ access_rpc 配置文件替换 ============================="
  sudo sed -i "s/localhost/${inner_ip}/g" ./access/endpoint/rpc/etc/access${env}.yaml
  sudo sed -i "s/127.0.0.1/${inner_ip}/g" ./access/endpoint/rpc/etc/access${env}.yaml

}

build_access_api() {
  echo "============================ access_api 配置文件替换 ============================="
  sudo sed -i "s/localhost/${inner_ip}/g" ./access/endpoint/api/etc/access-api${env}.yaml
  sudo sed -i "s/127.0.0.1/${inner_ip}/g" ./access/endpoint/api/etc/access-api${env}.yaml

}

build_kms_admin_api() {
  echo "============================ kms_admin_api 配置文件替换 ============================="
  sudo sed -i "s/localhost/${inner_ip}/g" ./kms_admin/etc/kms-admin-api${env}.yaml
  sudo sed -i "s/127.0.0.1/${inner_ip}/g" ./kms_admin/etc/kms-admin-api${env}.yaml

}

build_kms_server_api() {
  echo "============================ kms_server 配置文件替换 ============================="
  sudo sed -i "s/localhost/${inner_ip}/g" ./kms_server/etc/kmsserver-api${env}.yaml
  sudo sed -i "s/127.0.0.1/${inner_ip}/g" ./kms_server/etc/kmsserver-api${env}.yaml

}

build_users_rpc() {
  echo "============================ users_rpc 配置文件替换 ============================="
  sudo sed -i "s/localhost/${inner_ip}/g" ./users/endpoint/rpc/etc/users${env}.yaml
  sudo sed -i "s/127.0.0.1/${inner_ip}/g" ./users/endpoint/rpc/etc/users${env}.yaml

}

build_users_api() {
  echo "============================ users_api 配置文件替换 ============================="
  sudo sed -i "s/localhost/${inner_ip}/g" ./users/endpoint/api/etc/users-api${env}.yaml
  sudo sed -i "s/127.0.0.1/${inner_ip}/g" ./users/endpoint/api/etc/users-api${env}.yaml

}

build_kmsserver_api() {
  echo "============================ users_api 配置文件替换 ============================="
  sudo sed -i "s/localhost/${inner_ip}/g" ./kms_server/etc/kmsserver-api${env}.yaml
  sudo sed -i "s/127.0.0.1/${inner_ip}/g" ./kms_server/etc/kmsserver-api${env}.yaml

}

build_kmsaudit_api() {
  echo "============================ kms_audit_api 配置文件替换 ============================="
  sudo sed -i "s/localhost/${inner_ip}/g" ./kms_audit/etc/kmsaudit-api${env}.yaml
  sudo sed -i "s/127.0.0.1/${inner_ip}/g" ./kms_audit/etc/kmsaudit-api${env}.yaml

}

build_kmstask_api() {
  echo "============================ kms_task_api 配置文件替换 ============================="
  sudo sed -i "s/localhost/${inner_ip}/g" ./kms_task/etc/kmstask-api${env}.yaml
  sudo sed -i "s/127.0.0.1/${inner_ip}/g" ./kms_task/etc/kmstask-api${env}.yaml

}

build_access_rpc
build_access_api
build_kms_admin_api
build_users_rpc
build_users_api
build_kmsserver_api
build_kmsaudit_api
build_kmstask_api